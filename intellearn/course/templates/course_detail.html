{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <!-- Course Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold">{{ course.title }}</h2>
            <p class="text-muted">👨‍🏫 Instructor: {{ course.instructor.username }}</p>

            {% if course.thumbnail_url %}
                <img src="{{ course.thumbnail_url }}" class="img-fluid rounded mb-3" alt="{{ course.title }}">
            {% endif %}

            <p>{{ course.description }}</p>

            <p class="fw-bold text-success">💲 ฿{{ course.price }}</p>

            <p>
                📚 {{ lessons.count }} lessons <br>
                👩‍🎓 {{ students_count }} students
            </p>

            <!-- ✅ ปุ่ม Enroll -->
            {% if user.is_authenticated %}
                {% if is_enrolled %}
                    <button class="btn btn-secondary w-100 mb-3" disabled>
                        ✅ Already Enrolled
                    </button>
                {% else %}
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success w-100 mb-3">
                            📚 Enroll in this Course
                        </button>
                    </form>
                {% endif %}
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-primary w-100 mb-3">
                    🔑 Login to Enroll
                </a>
            {% endif %}
        </div>
    </div>

    <hr>

    <!-- Lessons List -->
    <h4 class="mt-4">Course Lessons</h4>
    <ul class="list-group">
        {% for lesson in lessons %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                    <strong>{{ lesson.order }}. {{ lesson.title }}</strong>
                    {% if lesson.content %}
                        <p class="mb-0 text-muted">{{ lesson.content|truncatewords:20 }}</p>
                    {% endif %}
                </div>
                <div>
                    {% if lesson.video_url %}
                        <a href="{{ lesson.video_url }}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                            ▶ Watch
                        </a>
                    {% endif %}

                    <!-- ✅ ปุ่มแก้ไข/ลบสำหรับ Instructor -->
                    {% if user == course.instructor or user.is_superuser %}
                        <a href="{% url 'edit_lesson' lesson.id %}" class="btn btn-sm btn-warning me-2">✏ Edit</a>
                        <a href="{% url 'delete_lesson' lesson.id %}" class="btn btn-sm btn-danger">🗑 Delete</a>
                    {% endif %}
                </div>
            </li>
        {% empty %}
            <li class="list-group-item">No lessons available yet.</li>
        {% endfor %}
    </ul>

    <!-- ✅ ปุ่มเพิ่ม Lesson -->
    {% if user == course.instructor or user.is_superuser %}
        <div class="mt-3">
            <a href="{% url 'course:add_lesson' course.id %}" class="btn btn-success">
                ➕ Add Lesson
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
